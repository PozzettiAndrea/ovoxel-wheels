name: Build O-Voxel CUDA 12.8

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

env:
  CUDA_VERSION: '12.8'
  CUDA_SHORT: '128'
  PYTORCH_VERSION: '2.8.0'
  TORCH_CUDA_ARCH_LIST: '7.5;8.0;8.6;8.9;9.0'
  MAX_JOBS: 4

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        python: ['3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo apt-get clean

      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install CUDA toolkit
        run: |
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          sudo apt-get update
          sudo apt-get install -y \
            cuda-nvcc-12-8 \
            cuda-cudart-dev-12-8 \
            libcublas-dev-12-8 \
            libcusparse-dev-12-8 \
            libcusolver-dev-12-8
          echo "/usr/local/cuda-12.8/bin" >> $GITHUB_PATH
          echo "CUDA_HOME=/usr/local/cuda-12.8" >> $GITHUB_ENV

      - name: Install PyTorch and build tools
        run: |
          pip install --no-cache-dir torch==${{ env.PYTORCH_VERSION }} --index-url https://download.pytorch.org/whl/cu128
          pip install wheel setuptools ninja numpy

      - name: Clone TRELLIS.2 and build o-voxel
        env:
          FORCE_CUDA: "1"
          CUDA_HOME: /usr/local/cuda-12.8
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git clone https://github.com/microsoft/TRELLIS.2.git
          cd TRELLIS.2/o-voxel
          export TORCH_CUDA_ARCH_LIST="${{ env.TORCH_CUDA_ARCH_LIST }}"
          pip install --no-build-isolation .
          python setup.py bdist_wheel
          ls -la dist/

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: ovoxel-linux-cu${{ env.CUDA_SHORT }}-py${{ matrix.python }}
          path: TRELLIS.2/o-voxel/dist/*.whl
          retention-days: 90

  build-windows:
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        python: ['3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Download and install CUDA toolkit
        shell: powershell
        run: |
          $installerUrl = "https://developer.download.nvidia.com/compute/cuda/12.8.1/network_installers/cuda_12.8.1_windows_network.exe"
          Invoke-WebRequest -Uri $installerUrl -OutFile "cuda_installer.exe" -UseBasicParsing
          Start-Process -FilePath "cuda_installer.exe" -ArgumentList "-s", "-n", "nvcc_12.8", "cudart_12.8", "cublas_12.8", "cublas_dev_12.8", "cusparse_12.8", "cusparse_dev_12.8", "cusolver_12.8", "cusolver_dev_12.8", "thrust_12.8" -Wait -NoNewWindow
          $cudaPath = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.8"
          echo "$cudaPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "CUDA_HOME=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Install PyTorch and build tools
        run: |
          pip install torch==${{ env.PYTORCH_VERSION }} --index-url https://download.pytorch.org/whl/cu128
          pip install wheel setuptools ninja numpy

      - name: Clone TRELLIS.2
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git clone https://github.com/microsoft/TRELLIS.2.git

      - name: Build wheel
        shell: cmd
        run: |
          cd TRELLIS.2\o-voxel
          set "CUDA_HOME=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.8"
          set FORCE_CUDA=1
          set TORCH_CUDA_ARCH_LIST=7.5;8.0;8.6;8.9;9.0
          pip install --no-build-isolation .
          python setup.py bdist_wheel
          dir dist

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: ovoxel-windows-cu${{ env.CUDA_SHORT }}-py${{ matrix.python }}
          path: TRELLIS.2/o-voxel/dist/*.whl
          retention-days: 90

  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: ovoxel-*
          merge-multiple: true

      - name: Collect and rename wheels
        run: |
          mkdir -p wheels
          for whl in artifacts/*.whl; do
            if [ -f "$whl" ]; then
              basename=$(basename "$whl")
              newname=$(echo "$basename" | sed "s/-cp/+cu${{ env.CUDA_SHORT }}-cp/")
              cp "$whl" "wheels/$newname"
            fi
          done
          ls -la wheels/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: cu${{ env.CUDA_SHORT }}
          name: O-Voxel CUDA ${{ env.CUDA_VERSION }}
          body: |
            Pre-built O-Voxel wheels for CUDA ${{ env.CUDA_VERSION }}

            **Install:**
            ```bash
            pip install o_voxel --find-links https://PozzettiAndrea.github.io/ovoxel-wheels/
            ```
          files: wheels/*.whl
          fail_on_unmatched_files: true
          make_latest: false

  update-index:
    needs: [release]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Generate index.html
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p wheels
          REPO="${{ github.repository }}"
          echo '<!DOCTYPE html><html><body>' > wheels/index.html
          for tag in cu124 cu128; do
            if gh release view "$tag" --json assets --jq '.assets[].name' 2>/dev/null | grep -q '.whl'; then
              gh release view "$tag" --json assets --jq '.assets[].name' | while read -r wheel; do
                sha256=$(gh release download "$tag" --pattern "$wheel" --output - 2>/dev/null | sha256sum | cut -d' ' -f1)
                echo "<a href=\"https://github.com/$REPO/releases/download/$tag/$wheel#sha256=$sha256\">$wheel</a><br>" >> wheels/index.html
              done
            fi
          done
          echo '</body></html>' >> wheels/index.html

      - name: Commit index
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add wheels/
          git commit -m "Update index" || echo "No changes"
          git pull --rebase origin main || true
          git push
