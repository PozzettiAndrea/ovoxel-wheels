name: Build O-Voxel CUDA 12.6 + PyTorch 2.8.0

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/build-cu126-torch280.yml'
    tags: ['v*']
  workflow_dispatch:

env:
  CUDA_VERSION: '12.6'
  CUDA_SHORT: '126'
  PYTORCH_VERSION: '2.8.0'
  TORCH_SHORT: '280'
  TORCH_MM: '28'
  TORCH_CUDA_ARCH_LIST: '7.5;8.0;8.6;8.9;9.0'
  MAX_JOBS: 4

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        python: ['3.10', '3.11', '3.12', '3.13']

    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo apt-get clean

      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install CUDA toolkit
        run: |
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          sudo apt-get update
          sudo apt-get install -y \
            cuda-nvcc-12-6 \
            cuda-cudart-dev-12-6 \
            libcublas-dev-12-6 \
            libcusparse-dev-12-6 \
            libcusolver-dev-12-6
          echo "/usr/local/cuda-12.6/bin" >> $GITHUB_PATH
          echo "CUDA_HOME=/usr/local/cuda-12.6" >> $GITHUB_ENV

      - name: Install PyTorch and build tools
        run: |
          pip install --no-cache-dir torch==${{ env.PYTORCH_VERSION }} --index-url https://download.pytorch.org/whl/cu126
          pip install wheel setuptools ninja numpy

      - name: Clone TRELLIS.2
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git clone https://github.com/microsoft/TRELLIS.2.git --recursive

      - name: Patch postprocess.py for batched BVH queries
        run: |
          cd TRELLIS.2/o-voxel
          python3 << 'PATCH_SCRIPT'
          import re
          with open('o_voxel/postprocess.py', 'r') as f:
              content = f.read()
          batched_func = '''

          def _batched_unsigned_distance(bvh, positions, batch_size=500000, return_uvw=False):
              """Batch unsigned_distance queries to avoid GPU kernel timeout. See: https://github.com/PozzettiAndrea/ComfyUI-TRELLIS2/issues/19"""
              N = positions.shape[0]
              if N <= batch_size:
                  return bvh.unsigned_distance(positions, return_uvw=return_uvw)
              distances_list, face_id_list, uvw_list = [], [], [] if return_uvw else None
              for i in range(0, N, batch_size):
                  d, f, u = bvh.unsigned_distance(positions[i:min(i+batch_size, N)], return_uvw=return_uvw)
                  distances_list.append(d)
                  face_id_list.append(f)
                  if return_uvw: uvw_list.append(u)
              import torch
              return torch.cat(distances_list), torch.cat(face_id_list), torch.cat(uvw_list) if return_uvw else None

          '''
          content = re.sub(r'(import cumesh\n)', r'\1' + batched_func, content)
          content = content.replace('_, face_id, uvw = bvh.unsigned_distance(valid_pos, return_uvw=True)',
                                    '_, face_id, uvw = _batched_unsigned_distance(bvh, valid_pos, return_uvw=True)')
          with open('o_voxel/postprocess.py', 'w') as f:
              f.write(content)
          print("Patched postprocess.py for batched BVH queries")
          PATCH_SCRIPT

      - name: Build o-voxel wheel
        env:
          FORCE_CUDA: "1"
          CUDA_HOME: /usr/local/cuda-12.6
        run: |
          cd TRELLIS.2/o-voxel
          sed -i '/cumesh@/d' pyproject.toml
          sed -i '/flex_gemm@/d' pyproject.toml
          export TORCH_CUDA_ARCH_LIST="${{ env.TORCH_CUDA_ARCH_LIST }}"
          export CXXFLAGS="-D_GLIBCXX_USE_CXX11_ABI=1"
          pip install --no-build-isolation .
          python setup.py bdist_wheel
          cd dist && for f in *.whl; do mv "$f" "$(echo $f | sed 's/-cp/+cu${{ env.CUDA_SHORT }}torch${{ env.TORCH_MM }}-cp/')"; done && cd ..
          ls -la dist/

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: ovoxel-linux-cu${{ env.CUDA_SHORT }}-torch${{ env.TORCH_SHORT }}-py${{ matrix.python }}
          path: TRELLIS.2/o-voxel/dist/*.whl
          retention-days: 90

  build-windows:
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        python: ['3.10', '3.11', '3.12', '3.13']

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Download and install CUDA toolkit
        shell: powershell
        run: |
          $installerUrl = "https://developer.download.nvidia.com/compute/cuda/12.6.3/network_installers/cuda_12.6.3_windows_network.exe"
          Invoke-WebRequest -Uri $installerUrl -OutFile "cuda_installer.exe" -UseBasicParsing
          Start-Process -FilePath "cuda_installer.exe" -ArgumentList "-s", "-n", "nvcc_12.6", "cudart_12.6", "cublas_12.6", "cublas_dev_12.6", "cusparse_12.6", "cusparse_dev_12.6", "cusolver_12.6", "cusolver_dev_12.6", "thrust_12.6" -Wait -NoNewWindow
          $cudaPath = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.6"
          echo "$cudaPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "CUDA_HOME=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Install PyTorch and build tools
        run: |
          pip install torch==${{ env.PYTORCH_VERSION }} --index-url https://download.pytorch.org/whl/cu126
          pip install wheel setuptools ninja numpy

      - name: Clone TRELLIS.2
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git clone https://github.com/microsoft/TRELLIS.2.git --recursive

      - name: Patch postprocess.py for batched BVH queries
        shell: bash
        run: |
          cd TRELLIS.2/o-voxel
          python << 'PATCH_SCRIPT'
          import re
          with open('o_voxel/postprocess.py', 'r') as f:
              content = f.read()
          batched_func = '''

          def _batched_unsigned_distance(bvh, positions, batch_size=500000, return_uvw=False):
              """Batch unsigned_distance queries to avoid GPU kernel timeout. See: https://github.com/PozzettiAndrea/ComfyUI-TRELLIS2/issues/19"""
              N = positions.shape[0]
              if N <= batch_size:
                  return bvh.unsigned_distance(positions, return_uvw=return_uvw)
              distances_list, face_id_list, uvw_list = [], [], [] if return_uvw else None
              for i in range(0, N, batch_size):
                  d, f, u = bvh.unsigned_distance(positions[i:min(i+batch_size, N)], return_uvw=return_uvw)
                  distances_list.append(d)
                  face_id_list.append(f)
                  if return_uvw: uvw_list.append(u)
              import torch
              return torch.cat(distances_list), torch.cat(face_id_list), torch.cat(uvw_list) if return_uvw else None

          '''
          content = re.sub(r'(import cumesh\n)', r'\1' + batched_func, content)
          content = content.replace('_, face_id, uvw = bvh.unsigned_distance(valid_pos, return_uvw=True)',
                                    '_, face_id, uvw = _batched_unsigned_distance(bvh, valid_pos, return_uvw=True)')
          with open('o_voxel/postprocess.py', 'w') as f:
              f.write(content)
          print("Patched postprocess.py for batched BVH queries")
          PATCH_SCRIPT

      - name: Patch source for MSVC compatibility
        shell: powershell
        run: |
          # Fix 1: Remove 'd' suffix from double literals (preserve Eigen types like Vector2d)
          $file = "TRELLIS.2\o-voxel\src\convert\flexible_dual_grid.cpp"
          (Get-Content $file) -replace '(?<![a-zA-Z_])(\d+\.?\d*(?:[eE][+-]?\d+)?)d\b', '$1' | Set-Content $file

          # Fix 2: Cast size_t to int64_t in torch calls (narrowing conversion error)
          # Pattern 1: torch::zeros({VAR1, VAR2}, ...) in filter_*.cpp
          foreach ($f in @("TRELLIS.2\o-voxel\src\io\filter_neighbor.cpp", "TRELLIS.2\o-voxel\src\io\filter_parent.cpp")) {
            (Get-Content $f) -replace 'torch::zeros\(\{(\w+),\s*(\w+)\}', 'torch::zeros({(int64_t)$1, (int64_t)$2}' | Set-Content $f
          }
          # Pattern 2: torch::from_blob(..., {expr.size()}, ...) in svo.cpp
          $svoFile = "TRELLIS.2\o-voxel\src\io\svo.cpp"
          (Get-Content $svoFile) -replace '\{(\w+)\.size\(\)\}', '{(int64_t)$1.size()}' | Set-Content $svoFile

          Write-Host "Patched source files for MSVC compatibility"

      - name: Patch pyproject.toml
        shell: bash
        run: |
          cd TRELLIS.2/o-voxel
          # Remove git URL dependencies from pyproject.toml
          sed -i '/cumesh@/d' pyproject.toml
          sed -i '/flex_gemm@/d' pyproject.toml

      - name: Patch setup.py for debug symbols
        shell: bash
        run: |
          cd TRELLIS.2/o-voxel
          python << 'PATCH_SCRIPT'
          import re

          with open('setup.py', 'r') as f:
              content = f.read()

          # Replace the extra_compile_args to add MSVC debug flags
          old_args = """extra_compile_args={
                "cxx": ["-O3", "-std=c++17"],
                "nvcc": ["-O3","-std=c++17"] + cc_flag,
            }"""

          new_args = """extra_compile_args={
                "cxx": ["/O2", "/Zi", "/std:c++17", "/EHsc"],  # MSVC flags with debug symbols
                "nvcc": ["-O3","-std=c++17", "-Xcompiler", "/Zi"] + cc_flag,
            },
            extra_link_args=["/DEBUG:FULL"]  # Embed debug info reference in .pyd"""

          content = content.replace(old_args, new_args)

          with open('setup.py', 'w') as f:
              f.write(content)

          print("Patched setup.py for MSVC debug symbols")
          PATCH_SCRIPT

      - name: Build wheel
        shell: cmd
        run: |
          cd TRELLIS.2\o-voxel
          set "CUDA_HOME=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.6"
          set FORCE_CUDA=1
          set TORCH_CUDA_ARCH_LIST=7.5;8.0;8.6;8.9;9.0
          pip install --no-build-isolation .
          python setup.py bdist_wheel
          dir dist

      - name: Rename wheel with CUDA+PyTorch suffix
        shell: powershell
        run: |
          cd TRELLIS.2\o-voxel\dist
          Get-ChildItem *.whl | ForEach-Object {
            # Only replace the first -cp (after version), not the second one (ABI tag)
            $newname = $_.Name -replace '^([^-]+-[0-9]+.[0-9]+.[0-9]+)-cp', '$1+cu${{ env.CUDA_SHORT }}torch${{ env.TORCH_MM }}-cp'
            Rename-Item $_.FullName $newname
          }
          Get-ChildItem

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: ovoxel-windows-cu${{ env.CUDA_SHORT }}-torch${{ env.TORCH_SHORT }}-py${{ matrix.python }}
          path: TRELLIS.2/o-voxel/dist/*.whl
          retention-days: 90

  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: ovoxel-*
          merge-multiple: true

      - name: Collect and rename wheels
        run: |
          mkdir -p wheels
          for whl in artifacts/*.whl; do
            if [ -f "$whl" ]; then
              basename=$(basename "$whl")
              newname="$basename"
              cp "$whl" "wheels/$newname"
            fi
          done
          ls -la wheels/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: cu${{ env.CUDA_SHORT }}-torch${{ env.TORCH_SHORT }}
          name: O-Voxel CUDA ${{ env.CUDA_VERSION }} + PyTorch ${{ env.PYTORCH_VERSION }}
          body: |
            Pre-built O-Voxel wheels for CUDA ${{ env.CUDA_VERSION }} + PyTorch ${{ env.PYTORCH_VERSION }}

            **Install:**
            ```bash
            pip install o_voxel --find-links https://PozzettiAndrea.github.io/ovoxel-wheels/
            ```
          files: wheels/*.whl
          fail_on_unmatched_files: true
          make_latest: false

  update-index:
    needs: [release]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Generate index.html for this release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          WHEEL_DIR="wheels/cu${{ env.CUDA_SHORT }}-torch${{ env.TORCH_SHORT }}"
          mkdir -p "$WHEEL_DIR"

          RELEASE_TAG="cu${{ env.CUDA_SHORT }}-torch${{ env.TORCH_SHORT }}"
          REPO="${{ github.repository }}"

          cat > "$WHEEL_DIR/index.html" << 'HEADER'
          <!DOCTYPE html>
          <html>
          <head>
              <title>O-Voxel Wheels - CUDA ${{ env.CUDA_VERSION }} + PyTorch ${{ env.PYTORCH_VERSION }}</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
                  a { color: #0366d6; }
                  pre { background: #f6f8fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
              </style>
          </head>
          <body>
          <h1>O-Voxel Wheels</h1>
          <p><strong>CUDA ${{ env.CUDA_VERSION }} + PyTorch ${{ env.PYTORCH_VERSION }}</strong></p>
          <h2>Install</h2>
          <pre>pip install o_voxel --find-links https://pozzettiandrea.github.io/ovoxel-wheels/cu${{ env.CUDA_SHORT }}-torch${{ env.TORCH_SHORT }}/</pre>
          <h2>Available Wheels</h2>
          HEADER

          gh release view "$RELEASE_TAG" --json assets --jq '.assets[].name' | while read -r wheel; do
            echo "<a href=\"https://github.com/$REPO/releases/download/$RELEASE_TAG/$wheel\">$wheel</a><br>" >> "$WHEEL_DIR/index.html"
          done

          cat >> "$WHEEL_DIR/index.html" << 'FOOTER'
          <p style="margin-top: 20px;"><a href="../">Back to index</a></p>
          </body>
          </html>
          FOOTER

      - name: Commit index.html
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add wheels/
          git commit -m "Update index: CUDA ${{ env.CUDA_VERSION }} + PyTorch ${{ env.PYTORCH_VERSION }}" || echo "No changes"
          git pull --rebase origin main || true
          git push
